name: CI

on:
  pull_request:
    branches:
      - main
      - dev/**

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.10"
  PYTHONPATH: .
  WANDB_MODE: offline
  OMP_NUM_THREADS: "1"
  MKL_THREADING_LAYER: SEQUENTIAL

jobs:
  pr:
    name: PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            environment.yml

      - name: Cache conda packages
        uses: actions/cache@v4
        with:
          path: ~/.conda/pkgs
          key: conda-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('environment.yml') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Restore mini data cache
        id: mini-data
        uses: actions/cache@v4
        with:
          path: artifacts/data-mini
          key: mini-data-${{ runner.os }}-${{ hashFiles('data/spy_sample.csv') }}

      - name: Ruff lint
        run: python -m ruff check scripts/aggregate.py scripts/prepare_data.py tools/check_golden.py

      - name: Black formatting
        run: python -m black --check scripts/aggregate.py scripts/prepare_data.py tools/check_golden.py

      - name: Type checking
        run: python -m mypy src

      - name: Run unit tests
        run: python -m pytest -m "not heavy"

      - name: Prepare staged data
        run: make data-mini

      - name: Clean staged artifacts
        run: |
          rm -rf artifacts/paper-lite
          rm -rf reports/lite

      - name: Paper lite pipeline
        run: make paper-lite

      - name: Generate lite report
        run: make report-lite

      - name: Validate golden metrics
        run: python tools/check_golden.py

      - name: Upload artifacts bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-artifacts
          path: |
            artifacts
            reports
          if-no-files-found: ignore
