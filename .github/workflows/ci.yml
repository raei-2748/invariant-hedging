name: CI
on:
  pull_request:
  push:
    branches: [ main ]
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.lock.txt') }}
    - name: Install deps
      run: |
        pip install -r requirements.lock.txt
        pip install pre-commit==3.8.0 pytest==8.3.2
        pre-commit install
    - name: Lint
      run: pre-commit run --all-files
    - name: Unit tests
      run: pytest -q
    - name: Smoke train
      run: make smoke-train
    - name: Smoke eval
      run: make smoke-eval
    - name: Collect diagnostics (best effort)
      run: |
        python -m src.diagnostics.collect --runs runs --out tables/diag.csv || true
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ci-artifacts
        path: |
          runs/**/final_metrics.json
          runs/**/config.yaml
          tables/diag.csv
          !runs/**/checkpoints/**
