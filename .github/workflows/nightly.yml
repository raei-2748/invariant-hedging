name: Nightly

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  PYTHON_VERSION: "3.10"
  PYTHONPATH: .
  WANDB_MODE: offline
  OMP_NUM_THREADS: "1"
  MKL_THREADING_LAYER: SEQUENTIAL

jobs:
  nightly:
    name: Full nightly pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 240
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: ./.github/actions/python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Restore dataset cache
        id: nightly-data
        uses: actions/cache@v4
        with:
          path: outputs/paper_data
          key: paper-data-${{ runner.os }}-${{ hashFiles('data/spy_sample.csv') }}
          restore-keys: |
            paper-data-${{ runner.os }}-

      - name: Prepare diagnostics directory
        run: mkdir -p artifacts/diagnostics

      - name: Stage full dataset
        run: make data 2>&1 | tee artifacts/diagnostics/data.log

      - name: Reset nightly outputs
        run: |
          rm -rf artifacts/paper-nightly
          rm -rf reports/nightly

      - name: Run paper pipeline (10 seeds)
        run: scripts/run_of_record.sh --seeds 10 --run-root artifacts/paper-nightly \
          2>&1 | tee artifacts/diagnostics/paper.log

      - name: Aggregate nightly report
        run: |
          PYTHONPATH=. python scripts/aggregate.py \
            --config configs/report/default.yaml \
            --out reports/nightly \
            --seed-dirs artifacts/paper-nightly/* \
            2>&1 | tee artifacts/diagnostics/aggregate.log

      - name: Validate golden baselines
        run: python tools/check_golden.py 2>&1 | tee artifacts/diagnostics/golden.log

      - name: Upload nightly diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-diagnostics
          path: artifacts/diagnostics
          if-no-files-found: warn

      - name: Upload nightly artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-artifacts
          path: |
            artifacts
            reports
          if-no-files-found: ignore

      - name: Archive release payloads
        if: always()
        run: |
          if [ -d artifacts/paper-nightly ]; then
            tar -czf paper-nightly-artifacts.tar.gz -C artifacts paper-nightly
          fi
          if [ -d reports/nightly ]; then
            tar -czf nightly-report.tar.gz -C reports nightly
          fi

      - name: Publish nightly draft release
        if: always()
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: true
          tag_name: nightly-${{ github.run_id }}
          name: Nightly run ${{ github.run_id }}
          body: |
            Automated nightly pipeline executed on ${{ github.run_number }}.
            - Seeds: 10
            - Dataset: staged via `make data`
          files: |
            paper-nightly-artifacts.tar.gz
            nightly-report.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
